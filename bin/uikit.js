#!/usr/bin/env node

/**
 * UIKit CLI - å®‰è£…å™¨
 * ç”¨äºå®‰è£… UIKit å‘½ä»¤åˆ° Claude Code æˆ– Qoder
 */

import { readFileSync, writeFileSync, existsSync, mkdirSync, cpSync, rmSync, readdirSync } from 'fs';
import { join, dirname } from 'path';
import { fileURLToPath } from 'url';
import { homedir } from 'os';

// è·å–å½“å‰æ–‡ä»¶ç›®å½•
// å¯¹äºç¼–è¯‘åçš„ Bun äºŒè¿›åˆ¶ï¼Œimport.meta.url ä¼šæ˜¯ file:///$bunfs/root/uikit.js
// å¯¹äºæ™®é€šè¿è¡Œï¼Œimport.meta.url ä¼šæ˜¯å®é™…æ–‡ä»¶è·¯å¾„
const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

// æ£€æµ‹æ˜¯å¦æ˜¯ç¼–è¯‘åçš„äºŒè¿›åˆ¶ï¼ˆé€šè¿‡æ£€æŸ¥æ˜¯å¦åœ¨ $bunfs è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿä¸­ï¼‰
const isBunBinary = __dirname.startsWith('/$bunfs') || __dirname.startsWith('\\$bunfs');

// GitHub ä»“åº“é…ç½®
const GITHUB_REPO = 'lgh-dev/uikit';
const GITHUB_BRANCH = 'main';

// ç¡®å®š UIKit æ ¹ç›®å½•å’Œèµ„æºç›®å½•
let UIKIT_ROOT, SPECS_DIR, COMMANDS_DIR;

if (isBunBinary) {
  // ç¼–è¯‘åçš„äºŒè¿›åˆ¶æ–‡ä»¶
  UIKIT_ROOT = dirname(process.execPath);
  SPECS_DIR = join(UIKIT_ROOT, 'specs');
  COMMANDS_DIR = join(UIKIT_ROOT, 'commands');

  // å¼€å‘ç¯å¢ƒç‰¹æ®Šå¤„ç†ï¼šå¦‚æœäºŒè¿›åˆ¶åœ¨ dist/ ç›®å½•ï¼Œå°è¯•ä½¿ç”¨çˆ¶ç›®å½•çš„ specs å’Œ commands
  if (UIKIT_ROOT.endsWith('/dist') || UIKIT_ROOT.endsWith('\\dist')) {
    const parentDir = dirname(UIKIT_ROOT);
    const parentSpecs = join(parentDir, 'specs');
    const parentCommands = join(parentDir, 'commands');

    if (existsSync(parentSpecs)) {
      SPECS_DIR = parentSpecs;
    }
    if (existsSync(parentCommands)) {
      COMMANDS_DIR = parentCommands;
    }
  }
} else {
  // æºä»£ç è¿è¡Œ
  UIKIT_ROOT = join(__dirname, '..');
  SPECS_DIR = join(UIKIT_ROOT, 'specs');
  COMMANDS_DIR = join(UIKIT_ROOT, 'commands');
}

// ç‰ˆæœ¬å·
const VERSION = '1.0.0';

// ANSI é¢œè‰²
const colors = {
  reset: '\x1b[0m',
  red: '\x1b[31m',
  green: '\x1b[32m',
  yellow: '\x1b[33m',
  blue: '\x1b[34m',
  cyan: '\x1b[36m',
  gray: '\x1b[90m'
};

const log = {
  info: (msg) => console.log(`${colors.blue}[INFO]${colors.reset} ${msg}`),
  success: (msg) => console.log(`${colors.green}[SUCCESS]${colors.reset} ${msg}`),
  warning: (msg) => console.log(`${colors.yellow}[WARNING]${colors.reset} ${msg}`),
  error: (msg) => console.log(`${colors.red}[ERROR]${colors.reset} ${msg}`)
};

// æ˜¾ç¤º Banner
function showBanner() {
  console.log(`
${colors.cyan}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                               â•‘
â•‘           UIKit CLI v${VERSION}                    â•‘
â•‘         UI è§„èŒƒç®¡ç†å’Œå®‰è£…å·¥å…·                 â•‘
â•‘                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${colors.reset}
`);
}

// åˆ›å»ºå‘½ä»¤æ–‡ä»¶å†…å®¹
function createCommandContent(commandName, description, implementation) {
  return `#!/usr/bin/env node

/**
 * ${commandName} - ${description}
 * Generated by UIKit CLI
 */

import { readFileSync, writeFileSync, existsSync, mkdirSync, readdirSync } from 'fs';
import { join, dirname } from 'path';
import { homedir } from 'os';

const CONFIG_FILE = join(process.cwd(), '.uikit', 'current-spec.json');
const SPECS_DIR = join(homedir(), '.uikit', 'specs');

${implementation}

// æ‰§è¡Œä¸»å‡½æ•°
main().catch(error => {
  console.error('æ‰§è¡Œå¤±è´¥:', error.message);
  process.exit(1);
});
`;
}

// ä» GitHub ä¸‹è½½æ–‡ä»¶
async function downloadFromGitHub(path) {
  const url = `https://raw.githubusercontent.com/${GITHUB_REPO}/${GITHUB_BRANCH}/${path}`;

  try {
    const response = await fetch(url);
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    return await response.text();
  } catch (error) {
    throw new Error(`ä¸‹è½½å¤±è´¥: ${url} - ${error.message}`);
  }
}

// ä» GitHub ä¸‹è½½ç›®å½•ä¸­çš„æ‰€æœ‰æ–‡ä»¶
async function downloadDirectory(dirPath, targetDir) {
  const apiUrl = `https://api.github.com/repos/${GITHUB_REPO}/contents/${dirPath}?ref=${GITHUB_BRANCH}`;

  try {
    const response = await fetch(apiUrl);
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }

    const files = await response.json();

    // ç¡®ä¿ç›®æ ‡ç›®å½•å­˜åœ¨
    if (!existsSync(targetDir)) {
      mkdirSync(targetDir, { recursive: true });
    }

    // ä¸‹è½½æ‰€æœ‰æ–‡ä»¶
    for (const file of files) {
      if (file.type === 'file') {
        const content = await downloadFromGitHub(`${dirPath}/${file.name}`);
        writeFileSync(join(targetDir, file.name), content);
      }
    }
  } catch (error) {
    throw new Error(`ä¸‹è½½ç›®å½•å¤±è´¥: ${dirPath} - ${error.message}`);
  }
}

// åˆå§‹åŒ–é¡¹ç›®ï¼ˆåœ¨å½“å‰é¡¹ç›®ç›®å½•åˆ›å»º .uikit é…ç½®ï¼‰
async function initProject(platform) {
  const projectDir = process.cwd();
  const uikitDir = join(projectDir, '.uikit');
  const specsDir = join(uikitDir, 'specs');
  const configFile = join(uikitDir, 'current-spec.json');

  let platformName;
  if (platform === 'claude-code') {
    platformName = 'Claude Code';
  } else if (platform === 'qoder') {
    platformName = 'Qoder';
  } else {
    log.error(`ä¸æ”¯æŒçš„å¹³å°: ${platform}`);
    return;
  }

  log.info(`æ­£åœ¨ä¸º ${platformName} åˆå§‹åŒ–é¡¹ç›®...`);

  // åˆ›å»ºç›®å½•ç»“æ„
  if (!existsSync(uikitDir)) {
    mkdirSync(uikitDir, { recursive: true });
    log.success('âœ“ åˆ›å»º .uikit ç›®å½•');
  }

  if (!existsSync(specsDir)) {
    mkdirSync(specsDir, { recursive: true });
  }

  // å¤åˆ¶è§„èŒƒæ–‡ä»¶åˆ°é¡¹ç›®ç›®å½•
  // ä¼˜å…ˆä»æœ¬åœ°å¤åˆ¶ï¼ˆå¼€å‘ç¯å¢ƒï¼‰ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä» GitHub ä¸‹è½½
  if (existsSync(SPECS_DIR)) {
    cpSync(SPECS_DIR, specsDir, { recursive: true });
    log.success('âœ“ å¤åˆ¶è®¾è®¡è§„èŒƒæ–‡ä»¶åˆ°é¡¹ç›®');
  } else {
    log.info('ä» GitHub ä¸‹è½½è®¾è®¡è§„èŒƒæ–‡ä»¶...');
    try {
      await downloadDirectory('specs', specsDir);
      log.success('âœ“ ä¸‹è½½è®¾è®¡è§„èŒƒæ–‡ä»¶æˆåŠŸ');
    } catch (error) {
      log.error(`ä¸‹è½½è®¾è®¡è§„èŒƒæ–‡ä»¶å¤±è´¥: ${error.message}`);
      process.exit(1);
    }
  }

  // è¯»å–å‘½ä»¤å®šä¹‰æ–‡ä»¶
  // ä¼˜å…ˆä»æœ¬åœ°è¯»å–ï¼ˆå¼€å‘ç¯å¢ƒï¼‰ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä» GitHub ä¸‹è½½
  let switchContent, doContent, checkContent;

  if (existsSync(COMMANDS_DIR)) {
    switchContent = readFileSync(join(COMMANDS_DIR, 'uikit-switch.md'), 'utf-8');
    doContent = readFileSync(join(COMMANDS_DIR, 'uikit-do.md'), 'utf-8');
    checkContent = readFileSync(join(COMMANDS_DIR, 'uikit-check.md'), 'utf-8');
    log.success('âœ“ è¯»å–å‘½ä»¤å®šä¹‰æ–‡ä»¶');
  } else {
    log.info('ä» GitHub ä¸‹è½½å‘½ä»¤å®šä¹‰æ–‡ä»¶...');
    try {
      switchContent = await downloadFromGitHub('commands/uikit-switch.md');
      doContent = await downloadFromGitHub('commands/uikit-do.md');
      checkContent = await downloadFromGitHub('commands/uikit-check.md');
      log.success('âœ“ ä¸‹è½½å‘½ä»¤å®šä¹‰æ–‡ä»¶æˆåŠŸ');
    } catch (error) {
      log.error(`ä¸‹è½½å‘½ä»¤å®šä¹‰æ–‡ä»¶å¤±è´¥: ${error.message}`);
      process.exit(1);
    }
  }

  // ä¿å­˜åˆå§‹é…ç½®æ–‡ä»¶
  const initialConfig = {
    spec: null,
    installedAt: new Date().toISOString()
  };
  writeFileSync(configFile, JSON.stringify(initialConfig, null, 2));

  // ä¸ºå¯¹åº”å¹³å°åˆ›å»ºå‘½ä»¤é“¾æ¥
  let platformCommandsDir;
  if (platform === 'claude-code') {
    // Claude Code æ”¯æŒé¡¹ç›®çº§åˆ«çš„å‘½ä»¤ç›®å½•
    platformCommandsDir = join(projectDir, '.claude', 'commands');
  } else if (platform === 'qoder') {
    platformCommandsDir = join(projectDir, '.qoder', 'commands');
  }

  if (platformCommandsDir) {
    if (!existsSync(platformCommandsDir)) {
      mkdirSync(platformCommandsDir, { recursive: true });
    }

    // å†™å…¥å‘½ä»¤æ–‡ä»¶åˆ°å¹³å°å‘½ä»¤ç›®å½•
    const commands = [
      { name: 'uikit-switch', content: switchContent },
      { name: 'uikit-do', content: doContent },
      { name: 'uikit-check', content: checkContent }
    ];

    for (const cmd of commands) {
      const targetFile = join(platformCommandsDir, `${cmd.name}.md`);
      writeFileSync(targetFile, cmd.content);
      log.success(`âœ“ å®‰è£…å‘½ä»¤åˆ° ${platformName}: /${cmd.name}`);
    }
  }

  console.log(`
${colors.green}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${colors.reset}

âœ… UIKit å·²æˆåŠŸåˆå§‹åŒ–åˆ°é¡¹ç›®!

${colors.cyan}å¹³å°:${colors.reset} ${platformName}
${colors.cyan}é¡¹ç›®ç›®å½•:${colors.reset} ${projectDir}

${colors.cyan}å·²åˆ›å»ºçš„æ–‡ä»¶:${colors.reset}
  â€¢ .uikit/specs/              - è®¾è®¡è§„èŒƒæ–‡ä»¶
  â€¢ .uikit/current-spec.json   - å½“å‰é€‰ä¸­çš„è§„èŒƒ
  ${platform === 'claude-code' ? 'â€¢ .claude/commands/          - Claude Code å‘½ä»¤' : ''}
  ${platform === 'qoder' ? 'â€¢ .qoder/commands/           - Qoder å‘½ä»¤' : ''}

${colors.cyan}å¯ç”¨å‘½ä»¤:${colors.reset}
  â€¢ /uikit-switch - é€‰æ‹©è®¾è®¡è§„èŒƒ
  â€¢ /uikit-do     - æŒ‰è§„èŒƒå¼€å‘åŠŸèƒ½
  â€¢ /uikit-check  - å®¡æŸ¥åŠŸèƒ½åˆè§„æ€§

${colors.cyan}ä½¿ç”¨æ­¥éª¤:${colors.reset}
  1. ${colors.yellow}é‡å¯ ${platformName}${colors.reset}
  2. è¾“å…¥ / æŸ¥çœ‹å¯ç”¨å‘½ä»¤
  3. ä½¿ç”¨å‘½ä»¤å¼€å§‹å¼€å‘

${colors.gray}æç¤º: è§„èŒƒæ–‡ä»¶åœ¨ .uikit/specs/ ç›®å½•ä¸‹ï¼Œå¯ä»¥è‡ªç”±ä¿®æ”¹${colors.reset}

${colors.green}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${colors.reset}
`);
}

// å¸è½½é¡¹ç›®ä¸­çš„ UIKit
async function uninstallFromProject(platform) {
  const projectDir = process.cwd();
  const uikitDir = join(projectDir, '.uikit');

  let platformCommandsDir;
  let platformName;

  if (platform === 'claude-code') {
    platformCommandsDir = join(projectDir, '.claude', 'commands');
    platformName = 'Claude Code';
  } else if (platform === 'qoder') {
    platformCommandsDir = join(projectDir, '.qoder', 'commands');
    platformName = 'Qoder';
  } else if (platform === 'all') {
    // å¸è½½æ‰€æœ‰
    await uninstallFromProject('claude-code');
    await uninstallFromProject('qoder');

    // åˆ é™¤æ•´ä¸ª .uikit ç›®å½•
    if (existsSync(uikitDir)) {
      rmSync(uikitDir, { recursive: true });
      log.success('âœ“ åˆ é™¤ .uikit ç›®å½•');
    }
    return;
  } else {
    log.error(`ä¸æ”¯æŒçš„å¹³å°: ${platform}`);
    return;
  }

  log.info(`æ­£åœ¨ä»é¡¹ç›®ä¸­å¸è½½ ${platformName} çš„ UIKit é…ç½®...`);

  // åˆ é™¤å¹³å°å‘½ä»¤
  if (platformCommandsDir && existsSync(platformCommandsDir)) {
    const commands = ['uikit-switch.md', 'uikit-do.md', 'uikit-check.md'];
    for (const cmd of commands) {
      const cmdPath = join(platformCommandsDir, cmd);
      if (existsSync(cmdPath)) {
        rmSync(cmdPath);
        log.success(`âœ“ åˆ é™¤å‘½ä»¤: /${cmd.replace('.md', '')}`);
      }
    }
  }

  log.success(`UIKit å·²ä» ${platformName} å¸è½½`);
}

// æ˜¾ç¤ºçŠ¶æ€
function showStatus() {
  const projectDir = process.cwd();
  const uikitDir = join(projectDir, '.uikit');
  const configFile = join(uikitDir, 'current-spec.json');
  const specsDir = join(uikitDir, 'specs');
  const claudeCommandsDir = join(projectDir, '.claude', 'commands');
  const qoderCommandsDir = join(projectDir, '.qoder', 'commands');
  const commands = ['uikit-switch.md', 'uikit-do.md', 'uikit-check.md'];

  console.log(`
${colors.cyan}ğŸ“Š UIKit é¡¹ç›®çŠ¶æ€${colors.reset}
${'â”€'.repeat(50)}`);

  console.log(`${colors.cyan}é¡¹ç›®ç›®å½•:${colors.reset} ${projectDir}`);

  // æ£€æŸ¥æ˜¯å¦åˆå§‹åŒ–
  if (!existsSync(uikitDir)) {
    console.log(`\n${colors.gray}é¡¹ç›®å°šæœªåˆå§‹åŒ–${colors.reset}`);
    console.log(`è¿è¡Œ ${colors.cyan}uikit init claude${colors.reset} æˆ– ${colors.cyan}uikit init qoder${colors.reset} å¼€å§‹åˆå§‹åŒ–`);
    return;
  }

  // è¯»å–é…ç½®
  if (existsSync(configFile)) {
    try {
      const config = JSON.parse(readFileSync(configFile, 'utf-8'));
      if (config.spec) {
        console.log(`${colors.cyan}å½“å‰è§„èŒƒ:${colors.reset} ${config.spec}`);
      } else {
        console.log(`${colors.gray}å°šæœªé€‰æ‹©è§„èŒƒ${colors.reset}`);
      }
      console.log(`${colors.cyan}åˆå§‹åŒ–æ—¶é—´:${colors.reset} ${new Date(config.installedAt).toLocaleDateString()}`);
    } catch (e) {
      // å¿½ç•¥é”™è¯¯
    }
  }

  // Claude Code çŠ¶æ€
  console.log(`\n${colors.cyan}Claude Code:${colors.reset}`);
  let claudeInstalledCount = 0;
  for (const cmd of commands) {
    const cmdPath = join(claudeCommandsDir, cmd);
    const installed = existsSync(cmdPath);
    if (installed) claudeInstalledCount++;

    const cmdName = cmd.replace('.md', '');
    console.log(`  ${installed ? colors.green + 'âœ“' : colors.gray + 'â—‹'}${colors.reset} /${cmdName} ${installed ? '(å·²å®‰è£…)' : '(æœªå®‰è£…)'}`);
  }

  // Qoder çŠ¶æ€
  console.log(`\n${colors.cyan}Qoder:${colors.reset}`);
  let qoderInstalledCount = 0;
  for (const cmd of commands) {
    const cmdPath = join(qoderCommandsDir, cmd);
    const installed = existsSync(cmdPath);
    if (installed) qoderInstalledCount++;

    const cmdName = cmd.replace('.md', '');
    console.log(`  ${installed ? colors.green + 'âœ“' : colors.gray + 'â—‹'}${colors.reset} /${cmdName} ${installed ? '(å·²å®‰è£…)' : '(æœªå®‰è£…)'}`);
  }

  // è§„èŒƒæ–‡ä»¶çŠ¶æ€
  console.log(`\n${colors.cyan}è®¾è®¡è§„èŒƒ:${colors.reset}`);
  if (existsSync(specsDir)) {
    const specFiles = readdirSync(specsDir).filter(f => f.endsWith('.md'));
    console.log(`  ${colors.green}âœ“${colors.reset} ${specFiles.length} ä¸ªè§„èŒƒæ–‡ä»¶`);
    specFiles.forEach(file => {
      console.log(`  ${colors.gray}  â€¢ ${file.replace('.md', '')}${colors.reset}`);
    });
  } else {
    console.log(`  ${colors.gray}â—‹${colors.reset} æ— è§„èŒƒæ–‡ä»¶`);
  }

  // å½“å‰é€‰æ‹©çš„è§„èŒƒ
  const currentSpecFile = join(uikitDir, 'current-spec.json');
  if (existsSync(currentSpecFile)) {
    try {
      const currentSpec = JSON.parse(readFileSync(currentSpecFile, 'utf-8'));
      if (currentSpec.spec) {
        console.log(`\n${colors.cyan}å½“å‰è§„èŒƒ:${colors.reset} ${currentSpec.spec}`);
      }
    } catch (e) {
      // å¿½ç•¥é”™è¯¯
    }
  }

  console.log('â”€'.repeat(50));

  const totalInstalled = claudeInstalledCount + qoderInstalledCount;
  if (totalInstalled > 0) {
    console.log(`${colors.green}âœ… é¡¹ç›®å·²åˆå§‹åŒ–${colors.reset}`);
  } else {
    console.log(`${colors.yellow}âš ï¸  å‘½ä»¤å°šæœªå®‰è£…åˆ°ä»»ä½•å¹³å°${colors.reset}`);
    console.log(`è¿è¡Œ ${colors.cyan}uikit init claude${colors.reset} æˆ– ${colors.cyan}uikit init qoder${colors.reset} å®‰è£…å‘½ä»¤`);
  }
}

// æ˜¾ç¤ºå¸®åŠ©
function showHelp() {
  console.log(`
${colors.cyan}ç”¨æ³•:${colors.reset}
  uikit <command> [options]

${colors.cyan}å‘½ä»¤:${colors.reset}
  init <platform>   åˆå§‹åŒ– UIKit åˆ°æŒ‡å®šå¹³å°
  status            æŸ¥çœ‹å®‰è£…çŠ¶æ€
  uninstall         å¸è½½å‘½ä»¤
  help, -h          æ˜¾ç¤ºå¸®åŠ©
  -v, --version     æ˜¾ç¤ºç‰ˆæœ¬å·

${colors.cyan}åˆå§‹åŒ–ç¤ºä¾‹:${colors.reset}
  uikit init claude     # åˆå§‹åŒ–åˆ° Claude Code
  uikit init qoder      # åˆå§‹åŒ–åˆ° Qoder
  uikit init all        # åˆå§‹åŒ–åˆ°æ‰€æœ‰å¹³å°

${colors.cyan}æ”¯æŒçš„å¹³å°:${colors.reset}
  claude    Claude Code (å½“å‰æ”¯æŒ)
  qoder     Qoder (å½“å‰æ”¯æŒ)
  cursor    Cursor (è®¡åˆ’æ”¯æŒ)
  windsurf  Windsurf (è®¡åˆ’æ”¯æŒ)

${colors.cyan}ç¤ºä¾‹:${colors.reset}
  ${colors.gray}# æŸ¥çœ‹å½“å‰çŠ¶æ€${colors.reset}
  uikit status

  ${colors.gray}# åˆå§‹åŒ–åˆ° Claude Code${colors.reset}
  uikit init claude

  ${colors.gray}# åˆå§‹åŒ–åˆ° Qoder${colors.reset}
  uikit init qoder

  ${colors.gray}# æŸ¥çœ‹ç‰ˆæœ¬${colors.reset}
  uikit -v

${colors.cyan}ç‰ˆæœ¬:${colors.reset} ${VERSION}
`);
}

// ä¸»å‡½æ•°
async function main() {
  const args = process.argv.slice(2);
  const command = args[0];
  const target = args[1];

  // å¤„ç† -v, --version
  if (command === '-v' || command === '--version') {
    console.log(`UIKit CLI v${VERSION}`);
    return;
  }

  // å¤„ç† -h, --help
  if (command === '-h' || command === '--help') {
    showBanner();
    showHelp();
    return;
  }

  // æ²¡æœ‰å‘½ä»¤æ—¶æ˜¾ç¤ºçŠ¶æ€
  if (!command) {
    showBanner();
    showStatus();
    console.log(`\n${colors.gray}æç¤º: ä½¿ç”¨ 'uikit -h' æŸ¥çœ‹æ‰€æœ‰å‘½ä»¤${colors.reset}`);
    return;
  }

  switch (command) {
    case 'init':
      showBanner();

      // å¦‚æœæ²¡æœ‰æŒ‡å®šå¹³å°ï¼Œè®©ç”¨æˆ·é€‰æ‹©
      if (!target) {
        console.log(`
${colors.cyan}è¯·é€‰æ‹©è¦åˆå§‹åŒ–çš„å¹³å°:${colors.reset}
  1. Claude Code
  2. Qoder
  3. ä¸¤ä¸ªéƒ½å®‰è£…

${colors.gray}æç¤º: ä¸‹æ¬¡å¯ä»¥ç›´æ¥ä½¿ç”¨${colors.reset}
  ${colors.cyan}uikit init claude${colors.reset}  # åˆå§‹åŒ–åˆ° Claude Code
  ${colors.cyan}uikit init qoder${colors.reset}   # åˆå§‹åŒ–åˆ° Qoder
        `);

        // ä½¿ç”¨ readline è·å–ç”¨æˆ·è¾“å…¥
        const readline = await import('readline');
        const rl = readline.createInterface({
          input: process.stdin,
          output: process.stdout
        });

        const answer = await new Promise(resolve => {
          rl.question('è¯·é€‰æ‹© (1/2/3): ', resolve);
        });
        rl.close();

        switch (answer.trim()) {
          case '1':
            await initProject('claude-code');
            break;
          case '2':
            await initProject('qoder');
            break;
          case '3':
            await initProject('claude-code');
            await initProject('qoder');
            break;
          default:
            log.error('æ— æ•ˆé€‰æ‹©');
            process.exit(1);
        }
      } else {
        // å¦‚æœæŒ‡å®šäº†å¹³å°
        if (target === 'claude') {
          await initProject('claude-code');
        } else if (target === 'qoder') {
          await initProject('qoder');
        } else if (target === 'all') {
          await initProject('claude-code');
          await initProject('qoder');
        } else {
          log.error(`ä¸æ”¯æŒçš„å¹³å°: ${target}`);
          console.log('æ”¯æŒçš„å¹³å°: claude, qoder, all');
        }
      }
      break;

    // ä¿ç•™ install å‘½ä»¤å‘åå…¼å®¹
    case 'install':
      // é‡å®šå‘åˆ° init
      const initArgs = process.argv.slice(2);
      initArgs[0] = 'init';
      process.argv = [process.argv[0], process.argv[1], ...initArgs];
      await main();
      return;

    case 'uninstall':
      showBanner();
      if (!target) {
        console.log(`
${colors.cyan}è¯·é€‰æ‹©è¦å¸è½½çš„å¹³å°:${colors.reset}
  1. Claude Code
  2. Qoder
  3. ä¸¤ä¸ªéƒ½å¸è½½
        `);

        const readline = await import('readline');
        const rl = readline.createInterface({
          input: process.stdin,
          output: process.stdout
        });

        const answer = await new Promise(resolve => {
          rl.question('è¯·é€‰æ‹© (1/2/3): ', resolve);
        });
        rl.close();

        switch (answer.trim()) {
          case '1':
            await uninstallFromProject('claude-code');
            break;
          case '2':
            await uninstallFromProject('qoder');
            break;
          case '3':
            await uninstallFromProject('all');
            break;
          default:
            log.error('æ— æ•ˆé€‰æ‹©');
        }
      } else {
        if (target === 'claude' || target === 'qoder') {
          await uninstallFromProject(target === 'claude' ? 'claude-code' : target);
        } else if (target === 'all') {
          await uninstallFromProject('all');
        } else {
          log.error(`ä¸æ”¯æŒçš„å¹³å°: ${target}`);
        }
      }
      break;

    case 'status':
      showBanner();
      showStatus();
      break;

    case 'help':
    case '--help':
    case '-h':
      showBanner();
      showHelp();
      break;

    case 'version':
      console.log(`UIKit CLI v${VERSION}`);
      break;

    default:
      log.error(`æœªçŸ¥å‘½ä»¤: ${command}`);
      console.log();
      console.log(`${colors.cyan}å¯ç”¨å‘½ä»¤:${colors.reset}`);
      console.log('  init [platform]  - åˆå§‹åŒ–åˆ°æŒ‡å®šå¹³å°');
      console.log('  status          - æŸ¥çœ‹å®‰è£…çŠ¶æ€');
      console.log('  uninstall       - å¸è½½å‘½ä»¤');
      console.log('  help, -h        - æ˜¾ç¤ºå¸®åŠ©');
      console.log('  -v, --version   - æ˜¾ç¤ºç‰ˆæœ¬');
      console.log();
      console.log(`${colors.gray}ä½¿ç”¨ 'uikit -h' æŸ¥çœ‹è¯¦ç»†å¸®åŠ©${colors.reset}`);
      process.exit(1);
  }
}

// è¿è¡Œ
main().catch(error => {
  log.error(`æ‰§è¡Œå¤±è´¥: ${error.message}`);
  process.exit(1);
});